<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë‘ë”ì§€ ê²Œì„</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-image: url('grass.png');
      background-size: cover;
      background-position: center;
      transition: transform 0.1s ease-in-out;
    }

    .shake {
        animation: shake 0.2s;
    }

    @keyframes shake {
        0% { transform: translate(1px, 1px) rotate(0deg); }
        25% { transform: translate(-1px, -2px) rotate(-0.5deg); }
        50% { transform: translate(-2px, 0px) rotate(0.5deg); }
        75% { transform: translate(1px, 2px) rotate(0deg); }
        100% { transform: translate(1px, -1px) rotate(0.5deg); }
    }

    header {
      padding: 10px;
      background-color: rgba(240, 240, 240, 0.8);
      border-radius: 0 0 15px 15px;
    }

    #startBtn, #rankingBtn, #changeNicknameBtn, #helpBtn, #prevLevel, #nextLevel {
      padding: 10px 20px;
      font-size: 16px;
      margin: 5px;
    }

    #levelSelect {
      font-size: 16px;
      margin: 5px;
    }

    .hidden {
      display: none !important;
    }

    .holes {
      position: relative;
      width: 100vw;
      height: calc(100vh - 170px);
      overflow: hidden;
    }

    .hole {
      position: absolute;
      background-image: url('hole.png');
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      background-color: transparent;
      border-radius: 50%;
    }
    
    .mole, .decoy {
        position: absolute;
        bottom: 40%;
        left: 50%;
        transform: translateX(-50%);
        width: 80%;
        height: 80%;
        background-size: 80%;
        background-position: center bottom;
        background-repeat: no-repeat;
        border-radius: 50%;
        cursor: pointer;
        pointer-events: auto;
        transition: top 0.2s;
    }

    .mole {
       background-image: url('mole.png');
    }
    
    .penalty-display {
        position: absolute;
        font-size: 24px;
        font-weight: bold;
        color: red;
        text-shadow: 1px 1px 2px white;
        pointer-events: none;
        animation: floatUp 1s ease-out forwards;
    }

    @keyframes floatUp {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-50px); }
    }

    #countdown {
      font-size: 36px;
      font-weight: bold;
      color: white;
      text-shadow: 2px 2px 4px black;
      margin-top: 10px;
    }

    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 450px;
      background: white;
      border: 2px solid #888;
      border-radius: 10px;
      padding: 20px;
      display: none;
      z-index: 1000;
    }

    .modal-title {
      margin-top: 0;
      font-size: 22px;
    }
    
    .modal-content {
      text-align: left;
      margin-bottom: 15px;
    }

    #result-score {
        font-size: 48px;
        font-weight: bold;
        color: #007bff;
        text-align: center;
        margin: 10px 0;
    }
    #result-comment {
        text-align: center;
        font-style: italic;
        color: #555;
        margin-bottom: 20px;
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      display: none;
      z-index: 999;
    }
  </style>
</head>
<body>
  <!-- <audio id="bgm" src="bgm.mp3" loop></audio>
  <audio id="hitSound" src="hit.mp3"></audio>
  <audio id="missSound" src="miss.mp3"></audio> -->

  <header id="gameHeader">
    <h1>ë‘ë”ì§€ ì¡ê¸°!</h1>
    <p id="instruction">ğŸ® ì‹œì‘ì„ ëˆ„ë¥´ê³  ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
    <label for="levelSelect">ë‚œì´ë„ ì„ íƒ:</label>
    <select id="levelSelect">
      <option value="1">ë ˆë²¨ 1</option>
      <option value="2">ë ˆë²¨ 2</option>
      <option value="3">ë ˆë²¨ 3</option>
      <option value="4">ë ˆë²¨ 4</option>
      <option value="5">ë ˆë²¨ 5</option>
    </select>
    <div id="levelDisplay">ë ˆë²¨: 1</div>
    <button id="startBtn">ê²Œì„ ì‹œì‘</button>
    <button id="rankingBtn">ë­í‚¹ í™•ì¸</button>
    <button id="helpBtn">ê²Œì„ ì„¤ëª…</button>
    <button id="changeNicknameBtn">ë‹‰ë„¤ì„ ë³€ê²½</button>
    <p id="nicknameDisplay">í”Œë ˆì´ì–´: ì—†ìŒ</p>
    <p>ì ìˆ˜: <span id="score">0</span></p>
    <p>ë‚¨ì€ ì‹œê°„: <span id="time">30</span>ì´ˆ</p>
    <div id="countdown"></div>
  </header>

  <div class="holes" id="holesContainer"></div>
  <div id="overlay"></div>
  
  <div id="rankingDisplay" class="modal">
    <h3 id="rankingTitle" class="modal-title">ë ˆë²¨ 1 ë­í‚¹</h3>
    <div id="rankingContent" class="modal-content"></div>
    <button id="prevLevel">ì´ì „</button>
    <button id="nextLevel">ë‹¤ìŒ</button>
    <button onclick="closeModal('rankingDisplay')">ë‹«ê¸°</button>
  </div>
  
  <div id="helpDisplay" class="modal">
    <h3 id="helpTitle" class="modal-title">ğŸ“œ ê²Œì„ ì„¤ëª…</h3>
    <div id="helpContent" class="modal-content">
        <p><strong>- ëª©í‘œ:</strong> ì œí•œ ì‹œê°„ 30ì´ˆ ì•ˆì— ìµœëŒ€í•œ ë†’ì€ ì ìˆ˜ë¥¼ íšë“í•˜ì„¸ìš”!</p>
        <p><strong>- ì ìˆ˜ ì‹œìŠ¤í…œ (100ì  ë§Œì ):</strong></p>
        <ul>
            <li>ì ìˆ˜ëŠ” ë ˆë²¨ê³¼ ìƒê´€ì—†ì´ í”Œë ˆì´ì–´ì˜ ì‹¤ë ¥ì— ë”°ë¼ <strong>í‘œì¤€í™”ëœ ì ìˆ˜</strong>ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</li>
            <li>ë‘ë”ì§€ë¥¼ ì •í™•í•˜ê³  ë§ì´ ì¡ì„ìˆ˜ë¡ ë†’ì€ ì ìˆ˜ë¥¼ ë°›ìŠµë‹ˆë‹¤.</li>
            <li><strong>ë‘ë”ì§€</strong>ë¥¼ ì¡ìœ¼ë©´ ì ìˆ˜ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤.</li>
            <li><strong>ë‹¤ë¥¸ ìºë¦­í„°</strong>ë¥¼ ì¡ìœ¼ë©´ ê°ì ë˜ë‹ˆ ì£¼ì˜í•˜ì„¸ìš”!</li>
        </ul>
        <p><strong>- ë ˆë²¨:</strong> ë ˆë²¨ì´ ì˜¬ë¼ê°ˆìˆ˜ë¡ êµ¬ë©ê³¼ ìºë¦­í„° ìˆ˜ê°€ ëŠ˜ì–´ë‚˜ê³ , ë°©í•´ ìºë¦­í„°ê°€ ë” ìì£¼ ë‚˜íƒ€ë‚˜ ë‚œì´ë„ê°€ ìƒìŠ¹í•©ë‹ˆë‹¤.</p>
    </div>
    <button onclick="closeModal('helpDisplay')">ë‹«ê¸°</button>
  </div>
  
  <div id="resultDisplay" class="modal">
      <h3 class="modal-title">ğŸ“Š ê²Œì„ ê²°ê³¼ ë¶„ì„</h3>
      <div class="modal-content">
          <p id="result-score">100ì </p>
          <p id="result-comment">ì™„ë²½í•œ í”Œë ˆì´ì…ë‹ˆë‹¤!</p>
          <hr>
          <p><strong>ğŸ“ˆ ê²Œì„ ìš”ì•½</strong></p>
          <p>- ì¡ì€ ë‘ë”ì§€: <span id="moles-hit">0</span>ë§ˆë¦¬</p>
          <p>- ë†“ì¹œ ë‘ë”ì§€: <span id="moles-missed">0</span>ë§ˆë¦¬</p>
          <p>- ì˜ëª» ëˆ„ë¥¸ íšŸìˆ˜: <span id="decoys-hit">0</span>íšŒ</p>
          <hr>
          <p><strong>ğŸ¯ ìƒì„¸ ì§€í‘œ</strong></p>
          <p>- ì •í™•ë„: <span id="accuracy-rate">0</span>%</p>
          <p>- ë‘ë”ì§€ í¬íšë¥ : <span id="mole-capture-rate">0</span>%</p>
      </div>
      <button onclick="closeModal('resultDisplay')">í™•ì¸</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, push, get, query, orderByChild, equalTo, update } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDKTxGuQYjZlKiteYhbwApwcYKpXeGufoc",
      authDomain: "molegame-e285f.firebaseapp.com",
      projectId: "molegame-e285f",
      storageBucket: "molegame-e285f.appspot.com",
      messagingSenderId: "162520966799",
      appId: "1:162520966799:web:8624d770309ae0654db2fa",
      measurementId: "G-LDPZZX81H4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app, "https://molegame-e285f-default-rtdb.asia-southeast1.firebasedatabase.app");

    const decoyImages = ['decoy1.png', 'decoy2.png', 'decoy3.png'];

    let score = 0;
    let molesHit = 0;
    let decoysHit = 0;
    let totalMolesAppeared = 0;

    let timeLeft = 30;
    let level = 1;
    let currentRankingLevel = 1;
    let gameInterval;
    let timerInterval;
    let currentUserNickname = null;

    // âœ… [ì¶”ê°€] ì˜¤ë””ì˜¤ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    const bgm = document.getElementById('bgm');
    const hitSound = document.getElementById('hitSound');
    const missSound = document.getElementById('missSound');

    const scoreDisplay = document.getElementById('score');
    const timeDisplay = document.getElementById('time');
    const levelDisplay = document.getElementById('levelDisplay');
    const countdownDisplay = document.getElementById('countdown');
    const holesContainer = document.getElementById('holesContainer');
    const header = document.getElementById('gameHeader');
    const nicknameDisplay = document.getElementById('nicknameDisplay');
    
    // âœ… [ì¶”ê°€] ì˜¤ë””ì˜¤ ì¬ìƒì„ ìœ„í•œ í•¨ìˆ˜
    function playSound(sound) {
        sound.currentTime = 0; // ì¬ìƒ ìœ„ì¹˜ë¥¼ ì²˜ìŒìœ¼ë¡œ ë˜ëŒë¦¼
        sound.play();
    }

    document.getElementById('startBtn').addEventListener('click', () => {
      // âœ… [ì¶”ê°€] ê²Œì„ ì‹œì‘ ì‹œ ë°°ê²½ìŒì•… ì¬ìƒ
      bgm.play().catch(e => console.log("ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì´ í•„ìš”í•˜ì—¬ BGM ìë™ ì¬ìƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."));

      if (!currentUserNickname) {
        currentUserNickname = prompt("ê²Œì„ì—ì„œ ì‚¬ìš©í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”:");
        if (!currentUserNickname) {
          alert("ë‹‰ë„¤ì„ì´ ì…ë ¥ë˜ì§€ ì•Šì•„ ê²Œì„ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        nicknameDisplay.textContent = `í”Œë ˆì´ì–´: ${currentUserNickname}`;
      }
      
      level = parseInt(document.getElementById('levelSelect').value);
      levelDisplay.textContent = `ë ˆë²¨: ${level}`;
      startCountdown(() => {
        header.classList.add('hidden');
        startGame();
      });
    });
    
    document.getElementById('changeNicknameBtn').addEventListener('click', () => {
        const newNickname = prompt("ìƒˆë¡œìš´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”:", currentUserNickname || "");
        if (newNickname) {
            currentUserNickname = newNickname;
            nicknameDisplay.textContent = `í”Œë ˆì´ì–´: ${currentUserNickname}`;
            alert(`ë‹‰ë„¤ì„ì´ '${currentUserNickname}'(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
    });

    function startCountdown(callback) {
      countdownDisplay.textContent = `ë ˆë²¨ ${level} ì‹œì‘í•©ë‹ˆë‹¤`;
      let count = 3;
      const interval = setInterval(() => {
        countdownDisplay.textContent = count;
        count--;
        if (count < 0) {
          clearInterval(interval);
          countdownDisplay.textContent = '';
          callback();
        }
      }, 1000);
    }

    function isOverlapping(x, y, existing, size) {
      for (const pos of existing) {
        const dx = pos.x - x;
        const dy = pos.y - y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        if (distance < size) return true;
      }
      return false;
    }

    function createHoles(count) {
      holesContainer.innerHTML = '';
      const containerWidth = holesContainer.offsetWidth;
      const containerHeight = holesContainer.offsetHeight;
      const targetTotalHoleArea = (containerWidth * containerHeight) * 0.25;
      const singleHoleArea = targetTotalHoleArea / count;
      let holeSize = Math.sqrt(singleHoleArea);
      holeSize = Math.max(40, Math.min(holeSize, 80)); 
      const placed = [];
      const margin = holeSize * 0.1;

      for (let i = 0; i < count; i++) {
        let x, y, attempts = 0;
        do {
          x = Math.random() * (containerWidth - holeSize);
          y = Math.random() * (containerHeight - holeSize);
          attempts++;
        } while (isOverlapping(x, y, placed, holeSize + margin) && attempts < 100);

        if (attempts >= 100) {
             console.warn("ê²¹ì¹˜ì§€ ì•ŠëŠ” ìœ„ì¹˜ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
             continue;
        }
        placed.push({ x, y });
        const hole = document.createElement('div');
        hole.classList.add('hole');
        hole.style.width = `${holeSize}px`;
        hole.style.height = `${holeSize}px`;
        hole.style.left = `${x}px`;
        hole.style.top = `${y}px`;
        holesContainer.appendChild(hole);
      }
    }

    function showCharacters() {
      const maxMoles = { 1: 1, 2: 2, 3: 2, 4: 3, 5: 5 }[level];
      const moleCount = Math.floor(Math.random() * maxMoles) + 1;
      let decoyCount = 0;
      if (level <= 2) {
          if (Math.random() < 0.4) decoyCount = 1;
      } else {
          const rand = Math.random();
          if (rand < 0.3) decoyCount = 1;
          else if (rand < 0.6) decoyCount = 2;
      }

      const allHoles = Array.from(document.querySelectorAll('.hole'));
      const availableHoles = allHoles.filter(hole => !hole.hasChildNodes());
      availableHoles.sort(() => 0.5 - Math.random());

      for (let i = 0; i < Math.min(moleCount, availableHoles.length); i++) {
        const hole = availableHoles.pop();
        const mole = document.createElement('div');
        mole.classList.add('mole');
        mole.addEventListener('click', hitMole);
        mole.addEventListener('touchstart', hitMole, { passive: false });
        hole.appendChild(mole);
        totalMolesAppeared++;
        setTimeout(() => mole.remove(), 1500);
      }

      for (let i = 0; i < Math.min(decoyCount, availableHoles.length); i++) {
        const hole = availableHoles.pop();
        const decoy = document.createElement('div');
        decoy.classList.add('decoy');
        const randomDecoyImg = decoyImages[Math.floor(Math.random() * decoyImages.length)];
        decoy.style.backgroundImage = `url('${randomDecoyImg}')`;
        decoy.addEventListener('click', hitDecoy);
        decoy.addEventListener('touchstart', hitDecoy, { passive: false });
        hole.appendChild(decoy);
        setTimeout(() => decoy.remove(), 1800);
      }
    }

    function hitMole(e) {
      e.preventDefault();
      playSound(hitSound); // âœ… [ìˆ˜ì •] íƒ€ê²©ìŒ ì¬ìƒ
      score++;
      molesHit++;
      scoreDisplay.textContent = score;
      this.remove();
    }

    function hitDecoy(e) {
      e.preventDefault();
      playSound(missSound); // âœ… [ìˆ˜ì •] ì‹¤ìˆ˜ íš¨ê³¼ìŒ ì¬ìƒ
      score--;
      decoysHit++;
      scoreDisplay.textContent = score;
      
      document.body.classList.add('shake');
      setTimeout(() => document.body.classList.remove('shake'), 200);

      const penaltyText = document.createElement('div');
      penaltyText.textContent = `-1`;
      penaltyText.classList.add('penalty-display');
      penaltyText.style.left = `${e.clientX}px`;
      penaltyText.style.top = `${e.clientY - 30}px`;
      document.body.appendChild(penaltyText);

      setTimeout(() => penaltyText.remove(), 1000);
      this.remove();
    }

    function startGame() {
      score = 0;
      molesHit = 0;
      decoysHit = 0;
      totalMolesAppeared = 0;
      
      timeLeft = 30;
      scoreDisplay.textContent = score;
      timeDisplay.textContent = timeLeft;
      const holeCounts = { 1: 7, 2: 15, 3: 25, 4: 30, 5: 40 };
      createHoles(holeCounts[level]);
      
      gameInterval = setInterval(showCharacters, 800);
      
      timerInterval = setInterval(() => {
        timeLeft--;
        timeDisplay.textContent = timeLeft;
        if (timeLeft <= 0) {
          endGame();
        }
      }, 1000);
    }

    async function endGame() {
      clearInterval(gameInterval);
      clearInterval(timerInterval);
      document.querySelectorAll('.mole, .decoy').forEach(char => char.remove());

      const baseScore = totalMolesAppeared > 0 ? (molesHit / totalMolesAppeared) * 100 : 0;
      const penalty = decoysHit * 5;
      let finalScore = Math.round(baseScore - penalty);
      finalScore = Math.max(0, finalScore);

      showResultModal(finalScore);

      if (currentUserNickname) {
        const scoresRef = ref(db, `rankings/level${level}`);
        const userQuery = query(scoresRef, orderByChild('name'), equalTo(currentUserNickname));

        try {
            const snapshot = await get(userQuery);

            if (snapshot.exists()) {
                let existingKey = null;
                let existingScore = -1;
                snapshot.forEach((childSnapshot) => {
                    existingKey = childSnapshot.key;
                    existingScore = childSnapshot.val().score;
                });

                if (finalScore > existingScore) {
                    console.log(`âœ… ìµœê³  ê¸°ë¡ ê°±ì‹ ! ${existingScore} -> ${finalScore}`);
                    const updates = {};
                    updates[`/rankings/level${level}/${existingKey}/score`] = finalScore;
                    await update(ref(db), updates);
                } else {
                    console.log(`â• ì ìˆ˜(${finalScore})ê°€ ê¸°ì¡´ ê¸°ë¡(${existingScore})ë³´ë‹¤ ë‚®ì•„ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ`);
                }
            } else {
                console.log("âœ… ì²« ê¸°ë¡! ì ìˆ˜ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.");
                await push(scoresRef, { name: currentUserNickname, score: finalScore });
            }
        } catch (err) {
            console.error("âŒ ì ìˆ˜ ì €ì¥/ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", err);
            alert(`ë­í‚¹ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. Firebase ë°ì´í„°ë² ì´ìŠ¤ì˜ 'ê·œì¹™' ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.\n\nì˜¤ë¥˜: ${err.message}`);
        }
      } else {
        console.warn("ë‹‰ë„¤ì„ì´ ì—†ì–´ ì ìˆ˜ë¥¼ ì €ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      }

      header.classList.remove('hidden');
    }

    function askForNextLevel() {
        if (level < 5) {
            const next = confirm("ë‹¤ìŒ ë ˆë²¨ë¡œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?");
            if (next) {
                level++;
                document.getElementById('levelSelect').value = level;
                levelDisplay.textContent = `ë ˆë²¨: ${level}`;
                startCountdown(() => {
                    header.classList.add('hidden');
                    startGame();
                });
            }
        }
    }

    function showResultModal(finalScore) {
        const molesMissed = totalMolesAppeared - molesHit;
        const totalClicks = molesHit + decoysHit;
        const accuracy = totalClicks > 0 ? (molesHit / totalClicks) * 100 : 0;
        const captureRate = totalMolesAppeared > 0 ? (molesHit / totalMolesAppeared) * 100 : 0;

        document.getElementById('result-score').textContent = `${finalScore}ì `;
        document.getElementById('moles-hit').textContent = `${molesHit}`;
        document.getElementById('moles-missed').textContent = `${molesMissed}`;
        document.getElementById('decoys-hit').textContent = `${decoysHit}`;
        document.getElementById('accuracy-rate').textContent = `${accuracy.toFixed(1)}%`;
        document.getElementById('mole-capture-rate').textContent = `${captureRate.toFixed(1)}%`;
        
        let comment = "";
        if(finalScore >= 95) comment = "ğŸ† ì™„ë²½í•œ í”Œë ˆì´ì…ë‹ˆë‹¤! ìµœê³  ì‹¤ë ¥ìì‹œë„¤ìš”!";
        else if (finalScore >= 80) comment = "ğŸ‘ í›Œë¥­í•´ìš”! ì¡°ê¸ˆë§Œ ë”í•˜ë©´ 100ì ë„ ê°€ëŠ¥í•˜ê² ì–´ìš”.";
        else if (finalScore >= 60) comment = "ğŸ™‚ ì˜í–ˆì–´ìš”! ì‹¤ìˆ˜ë¥¼ ì¤„ì´ë©´ ë” ë†’ì€ ì ìˆ˜ë¥¼ ë°›ì„ ìˆ˜ ìˆì–´ìš”.";
        else comment = "ğŸ˜‚ ì•„ì‰½ë„¤ìš”! ë‹¤ìŒì—” ë” ì˜í•  ìˆ˜ ìˆì„ ê±°ì˜ˆìš”.";

        document.getElementById('result-comment').textContent = comment;

        document.getElementById('overlay').style.display = 'block';
        document.getElementById('resultDisplay').style.display = 'block';
    }
    
    async function loadRanking(level) {
      const scoresRef = ref(db, `rankings/level${level}`);
      const rankingContent = document.getElementById('rankingContent');
      const rankingTitle = document.getElementById('rankingTitle');

      rankingTitle.textContent = `ë ˆë²¨ ${level} ë­í‚¹`;
      rankingContent.innerHTML = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';

      try {
        const snapshot = await get(scoresRef);
        if (!snapshot.exists()) {
          rankingContent.innerHTML = '<p>ì•„ì§ ë‹¬ì„±ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          return;
        }

        const data = [];
        snapshot.forEach(child => {
          const val = child.val();
          if (val && typeof val.score === 'number') {
            data.push(val);
          }
        });
        
        rankingContent.innerHTML = '';
        data.sort((a, b) => b.score - a.score);
        const top10 = data.slice(0, 10);

        top10.forEach((entry, idx) => {
          rankingContent.innerHTML += `<p>${idx + 1}. ${entry.name} - ${entry.score}ì </p>`;
        });
      } catch (error) {
        console.error("âŒ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
        rankingContent.innerHTML = '<p>ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
      }
    }

    document.getElementById('rankingBtn').addEventListener('click', () => {
      currentRankingLevel = parseInt(document.getElementById('levelSelect').value);
      loadRanking(currentRankingLevel);
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('rankingDisplay').style.display = 'block';
    });

    document.getElementById('helpBtn').addEventListener('click', () => {
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('helpDisplay').style.display = 'block';
    });

    document.getElementById('prevLevel').addEventListener('click', () => {
      if (currentRankingLevel > 1) {
        currentRankingLevel--;
        loadRanking(currentRankingLevel);
      }
    });

    document.getElementById('nextLevel').addEventListener('click', () => {
      if (currentRankingLevel < 5) {
        currentRankingLevel++;
        loadRanking(currentRankingLevel);
      }
    });
    
    window.closeModal = function (modalId) {
      document.getElementById('overlay').style.display = 'none';
      document.getElementById(modalId).style.display = 'none';

      if (modalId === 'resultDisplay') {
          askForNextLevel();
      }
    };
  </script>
</body>
</html>
